{% extends "core/base.html" %}
{% load static %}
{% load rbac_tags %}

{% block title %}Server Details - {{ server.name }} - StackWatch{% endblock %}

{% block bodyclass %}server-details-page{% endblock %}

{% block content %}
<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
<!-- Page Header -->
<div style="margin-bottom: var(--cds-spacing-8);">
    <nav style="margin-bottom: var(--cds-spacing-4); font-size: var(--cds-font-size-sm); color: var(--cds-color-gray-70);">
        <a href="{% url 'monitoring_dashboard' %}" style="color: var(--cds-color-blue-60); text-decoration: none;">Dashboard</a>
        <span style="margin: 0 var(--cds-spacing-2);">/</span>
        <span style="color: var(--cds-color-gray-100); font-weight: var(--cds-font-weight-medium);">{{ server.name }}</span>
    </nav>

    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: var(--cds-spacing-4); flex-wrap: wrap;">
        <div>
            <h1 style="font-size: var(--cds-font-size-3xl); font-weight: var(--cds-font-weight-bold); color: var(--cds-color-gray-100); margin: 0 0 var(--cds-spacing-1) 0;">{{ server.name }}</h1>
            <div style="display: flex; align-items: center; gap: var(--cds-spacing-2); font-size: var(--cds-font-size-sm); color: var(--cds-color-gray-70);">
                <span style="font-family: var(--cds-font-family-mono);">{{ server.ip_address }}</span>
                <span>•</span>
                <span id="server-status-text" style="font-weight: var(--cds-font-weight-medium);">Checking status...</span>
            </div>
        </div>

        <div style="display: flex; align-items: center; gap: var(--cds-spacing-2);">
            {% if user.is_staff or user.is_superuser %}
            <a href="/server/edit/{{ server.id }}/" style="display: inline-flex; align-items: center; gap: var(--cds-spacing-2); padding: var(--cds-spacing-2) var(--cds-spacing-4); font-size: var(--cds-font-size-sm); font-weight: var(--cds-font-weight-medium); color: var(--cds-color-gray-100); background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius); text-decoration: none;">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Edit Server
            </a>
            <a href="{% url 'server_anomalies_log' server.id %}" style="display: inline-flex; align-items: center; gap: var(--cds-spacing-2); padding: var(--cds-spacing-2) var(--cds-spacing-4); font-size: var(--cds-font-size-sm); font-weight: var(--cds-font-weight-medium); color: var(--cds-color-gray-100); background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius); text-decoration: none;">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Anomalies Log
            </a>
            {% endif %}
            <label style="display: inline-flex; align-items: center; gap: var(--cds-spacing-2); padding: var(--cds-spacing-2) var(--cds-spacing-4); font-size: var(--cds-font-size-sm); font-weight: var(--cds-font-weight-medium); color: var(--cds-color-gray-100); background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius); cursor: pointer;">
                <span>Auto-Refresh</span>
                <input type="checkbox" id="auto-refresh-toggle" checked style="width: 16px; height: 16px;">
            </label>
        </div>
    </div>
</div>

<input type="hidden" id="server-id" value="{{ server.id }}">

<!-- CPU Section -->
<div style="background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius); padding: var(--cds-spacing-6); margin-bottom: var(--cds-spacing-6);">
    <h2 style="font-size: var(--cds-font-size-xl); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100); margin: 0 0 var(--cds-spacing-4) 0;">CPU</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--cds-spacing-4); margin-bottom: var(--cds-spacing-4);">
        <div>
            <div style="font-size: var(--cds-font-size-xs); color: var(--cds-color-gray-70); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--cds-spacing-1);">CPU Usage</div>
            <div style="font-size: var(--cds-font-size-lg); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100);" id="cpu-percent">{% if latest_metric %}{{ latest_metric.cpu_percent|default:"--"|floatformat:1 }}%{% else %}--%{% endif %}</div>
        </div>
        <div>
            <div style="font-size: var(--cds-font-size-xs); color: var(--cds-color-gray-70); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--cds-spacing-1);">Cores</div>
            <div style="font-size: var(--cds-font-size-lg); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100);" id="cpu-cores">{% if latest_metric %}{{ latest_metric.cpu_count|default:"--" }}{% else %}--{% endif %}</div>
        </div>
        <div>
            <div style="font-size: var(--cds-font-size-xs); color: var(--cds-color-gray-70); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--cds-spacing-1);">Load Average (1m)</div>
            <div style="font-size: var(--cds-font-size-lg); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100);" id="cpu-load-avg">{% if latest_metric and latest_metric.cpu_load_avg_1m %}{{ latest_metric.cpu_load_avg_1m|floatformat:2 }}{% else %}--{% endif %}</div>
        </div>
    </div>
    
    <div>
        <div style="font-size: var(--cds-font-size-sm); font-weight: var(--cds-font-weight-medium); color: var(--cds-color-gray-100); margin-bottom: var(--cds-spacing-2);">Top 3 CPU Processes</div>
        <div id="top-cpu-processes" style="font-size: var(--cds-font-size-sm); color: var(--cds-color-gray-70);">
            <div style="padding: var(--cds-spacing-2); background-color: var(--cds-color-gray-10); border-radius: var(--cds-border-radius);">Loading...</div>
        </div>
    </div>
</div>

<!-- RAM Section -->
<div style="background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius); padding: var(--cds-spacing-6); margin-bottom: var(--cds-spacing-6);">
    <h2 style="font-size: var(--cds-font-size-xl); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100); margin: 0 0 var(--cds-spacing-4) 0;">RAM</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--cds-spacing-4); margin-bottom: var(--cds-spacing-4);">
        <div>
            <div style="font-size: var(--cds-font-size-xs); color: var(--cds-color-gray-70); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--cds-spacing-1);">Total RAM</div>
            <div style="font-size: var(--cds-font-size-lg); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100);" id="ram-total">{% if latest_metric %}{{ latest_metric.memory_total|filesizeformat }}{% else %}--{% endif %}</div>
        </div>
        <div>
            <div style="font-size: var(--cds-font-size-xs); color: var(--cds-color-gray-70); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--cds-spacing-1);">Free RAM</div>
            <div style="font-size: var(--cds-font-size-lg); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100);" id="ram-free">{% if latest_metric %}{{ latest_metric.memory_available|filesizeformat }}{% else %}--{% endif %}</div>
        </div>
        <div>
            <div style="font-size: var(--cds-font-size-xs); color: var(--cds-color-gray-70); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--cds-spacing-1);">Cached</div>
            <div style="font-size: var(--cds-font-size-lg); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100);" id="ram-cached">{% if latest_metric and latest_metric.memory_cached %}{{ latest_metric.memory_cached|filesizeformat }}{% else %}--{% endif %}</div>
        </div>
        {% if latest_metric and latest_metric.swap_total %}
        <div>
            <div style="font-size: var(--cds-font-size-xs); color: var(--cds-color-gray-70); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--cds-spacing-1);">Swap (Total/Used)</div>
            <div style="font-size: var(--cds-font-size-lg); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100);" id="swap-info">{{ latest_metric.swap_total|filesizeformat }} / {{ latest_metric.swap_used|default:0|filesizeformat }}</div>
        </div>
        {% endif %}
    </div>
    
    <div>
        <div style="font-size: var(--cds-font-size-sm); font-weight: var(--cds-font-weight-medium); color: var(--cds-color-gray-100); margin-bottom: var(--cds-spacing-2);">Top 3 RAM Processes</div>
        <div id="top-ram-processes" style="font-size: var(--cds-font-size-sm); color: var(--cds-color-gray-70);">
            <div style="padding: var(--cds-spacing-2); background-color: var(--cds-color-gray-10); border-radius: var(--cds-border-radius);">Loading...</div>
        </div>
    </div>
</div>

<!-- Disk Usage Section -->
<div style="background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius); padding: var(--cds-spacing-6); margin-bottom: var(--cds-spacing-6);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--cds-spacing-4);">
        <h2 style="font-size: var(--cds-font-size-xl); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100); margin: 0;">Disk Usage</h2>
        <button onclick="openDiskModal()" style="padding: var(--cds-spacing-1) var(--cds-spacing-3); font-size: var(--cds-font-size-sm); font-weight: var(--cds-font-weight-medium); color: var(--cds-color-blue-60); background-color: var(--cds-color-white); border: 1px solid var(--cds-color-blue-60); border-radius: var(--cds-border-radius); cursor: pointer;">Select Disks</button>
    </div>
    
    <div style="margin-bottom: var(--cds-spacing-4);">
        <div style="font-size: var(--cds-font-size-xs); color: var(--cds-color-gray-70); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--cds-spacing-1);">Number of Disks</div>
        <div style="font-size: var(--cds-font-size-lg); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100);">{{ disk_summary.total_disks|default:0 }}</div>
    </div>
    
    <div id="disk-list">
        <!-- Show all monitored disks -->
        {% if disk_data %}
        {% for mount_point in monitored_disks %}
        {% for disk_mount, info in disk_data.items %}
        {% if disk_mount == mount_point %}
        <div style="padding: var(--cds-spacing-3); background-color: var(--cds-color-gray-10); border-radius: var(--cds-border-radius); margin-bottom: var(--cds-spacing-2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--cds-spacing-2);">
                <div style="font-weight: var(--cds-font-weight-medium); color: var(--cds-color-gray-100);">{{ mount_point }}{% if mount_point == "/" %} (Root){% endif %}</div>
                <div style="font-size: var(--cds-font-size-sm); color: var(--cds-color-gray-70);">{{ info.percent|default:0|floatformat:1 }}%</div>
            </div>
            <div style="height: 8px; background-color: var(--cds-color-gray-20); border-radius: 4px; overflow: hidden;">
                <div style="height: 100%; background-color: var(--cds-color-blue-60); width: {{ info.percent|default:0 }}%; transition: width 0.3s ease;"></div>
            </div>
            <div style="font-size: var(--cds-font-size-xs); color: var(--cds-color-gray-70); margin-top: var(--cds-spacing-1);">
                {{ info.used|filesizeformat }} / {{ info.total|filesizeformat }}
            </div>
        </div>
        {% endif %}
        {% endfor %}
        {% endfor %}
        {% endif %}
    </div>
</div>

<!-- Graphs Section -->
<div style="margin-bottom: var(--cds-spacing-6);">
    <h2 style="font-size: var(--cds-font-size-xl); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100); margin: 0 0 var(--cds-spacing-4) 0;">Anomaly and Metrics Graphs</h2>
    
    <!-- CPU & Memory Graph -->
    <div style="background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius); padding: var(--cds-spacing-6); margin-bottom: var(--cds-spacing-4);">
        <h3 style="font-size: var(--cds-font-size-lg); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100); margin: 0 0 var(--cds-spacing-4) 0;">CPU & Memory</h3>
        <div style="position: relative; height: 300px;">
            <canvas id="cpu-memory-chart"></canvas>
        </div>
    </div>
    
    <!-- Disk I/O Graph -->
    <div style="background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius); padding: var(--cds-spacing-6); margin-bottom: var(--cds-spacing-4);">
        <h3 style="font-size: var(--cds-font-size-lg); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100); margin: 0 0 var(--cds-spacing-4) 0;">Disk I/O</h3>
        <div style="position: relative; height: 300px;">
            <canvas id="disk-io-chart"></canvas>
        </div>
    </div>
    
    <!-- Network I/O Graph -->
    <div style="background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius); padding: var(--cds-spacing-6);">
        <h3 style="font-size: var(--cds-font-size-lg); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100); margin: 0 0 var(--cds-spacing-4) 0;">Network I/O (In/Out)</h3>
        <div style="position: relative; height: 300px;">
            <canvas id="network-io-chart"></canvas>
        </div>
    </div>
</div>

<!-- SLO Configuration and Compliance Section -->
<div id="slo-configuration-section" style="background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius); padding: var(--cds-spacing-6); margin-bottom: var(--cds-spacing-6);">
    <h2 style="font-size: var(--cds-font-size-xl); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100); margin: 0 0 var(--cds-spacing-4) 0;">SLO Configuration & Compliance</h2>
    <div id="slo-configuration-container">
        <!-- SLO configuration will be loaded here by JavaScript -->
    </div>
</div>

<!-- Services Status Section -->
<div style="background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius); padding: var(--cds-spacing-6); margin-bottom: var(--cds-spacing-6);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--cds-spacing-4);">
        <h2 style="font-size: var(--cds-font-size-xl); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100); margin: 0;">Services Status</h2>
        <div style="display: flex; gap: var(--cds-spacing-2);">
            <button onclick="showServices('enabled')" id="btn-enabled" style="padding: var(--cds-spacing-1) var(--cds-spacing-3); font-size: var(--cds-font-size-sm); font-weight: var(--cds-font-weight-medium); color: var(--cds-color-white); background-color: var(--cds-color-blue-60); border: none; border-radius: var(--cds-border-radius); cursor: pointer;">Enabled</button>
            <button onclick="showServices('critical')" id="btn-critical" style="padding: var(--cds-spacing-1) var(--cds-spacing-3); font-size: var(--cds-font-size-sm); font-weight: var(--cds-font-weight-medium); color: var(--cds-color-gray-100); background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius); cursor: pointer;">Critical</button>
            <button onclick="showServices('all')" id="btn-all" style="padding: var(--cds-spacing-1) var(--cds-spacing-3); font-size: var(--cds-font-size-sm); font-weight: var(--cds-font-weight-medium); color: var(--cds-color-gray-100); background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius); cursor: pointer;">All</button>
        </div>
    </div>
    
    <div id="services-list">
        <!-- Services will be loaded here -->
    </div>
</div>

<!-- Threshold Values Section -->
<div style="background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius); padding: var(--cds-spacing-6);">
    <h2 style="font-size: var(--cds-font-size-xl); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100); margin: 0 0 var(--cds-spacing-4) 0;">Threshold Values</h2>
    
    <form id="thresholds-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--cds-spacing-4);">
        <div>
            <label style="display: block; font-size: var(--cds-font-size-sm); font-weight: var(--cds-font-weight-medium); color: var(--cds-color-gray-100); margin-bottom: var(--cds-spacing-1);">CPU Threshold (%)</label>
            <input type="number" name="cpu_threshold" value="{{ server.monitoring_config.cpu_threshold|default:80 }}" min="0" max="100" step="0.1" style="width: 100%; padding: var(--cds-spacing-2); font-size: var(--cds-font-size-sm); color: var(--cds-color-gray-100); background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius);">
        </div>
        <div>
            <label style="display: block; font-size: var(--cds-font-size-sm); font-weight: var(--cds-font-weight-medium); color: var(--cds-color-gray-100); margin-bottom: var(--cds-spacing-1);">Memory Threshold (%)</label>
            <input type="number" name="memory_threshold" value="{{ server.monitoring_config.memory_threshold|default:85 }}" min="0" max="100" step="0.1" style="width: 100%; padding: var(--cds-spacing-2); font-size: var(--cds-font-size-sm); color: var(--cds-color-gray-100); background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius);">
        </div>
        <div>
            <label style="display: block; font-size: var(--cds-font-size-sm); font-weight: var(--cds-font-weight-medium); color: var(--cds-color-gray-100); margin-bottom: var(--cds-spacing-1);">Disk Usage Threshold (%)</label>
            <input type="number" name="disk_threshold" value="{{ server.monitoring_config.disk_threshold|default:90 }}" min="0" max="100" step="0.1" style="width: 100%; padding: var(--cds-spacing-2); font-size: var(--cds-font-size-sm); color: var(--cds-color-gray-100); background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius);">
        </div>
        <div>
            <label style="display: block; font-size: var(--cds-font-size-sm); font-weight: var(--cds-font-weight-medium); color: var(--cds-color-gray-100); margin-bottom: var(--cds-spacing-1);">Disk I/O Threshold (MB/s)</label>
            <input type="number" name="disk_io_threshold" value="{% if server.monitoring_config.disk_io_threshold %}{{ server.monitoring_config.disk_io_threshold|floatformat:2 }}{% else %}1000{% endif %}" min="0" step="0.1" style="width: 100%; padding: var(--cds-spacing-2); font-size: var(--cds-font-size-sm); color: var(--cds-color-gray-100); background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius);">
        </div>
        <div>
            <label style="display: block; font-size: var(--cds-font-size-sm); font-weight: var(--cds-font-weight-medium); color: var(--cds-color-gray-100); margin-bottom: var(--cds-spacing-1);">Network I/O Threshold (MB/s)</label>
            <input type="number" name="network_io_threshold" value="{% if server.monitoring_config.network_io_threshold %}{{ server.monitoring_config.network_io_threshold|floatformat:2 }}{% else %}1000{% endif %}" min="0" step="0.1" style="width: 100%; padding: var(--cds-spacing-2); font-size: var(--cds-font-size-sm); color: var(--cds-color-gray-100); background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius);">
        </div>
        <div style="display: flex; align-items: flex-end;">
            <button type="submit" style="padding: var(--cds-spacing-2) var(--cds-spacing-4); font-size: var(--cds-font-size-sm); font-weight: var(--cds-font-weight-medium); color: var(--cds-color-white); background-color: var(--cds-color-blue-60); border: none; border-radius: var(--cds-border-radius); cursor: pointer;">Save Thresholds</button>
        </div>
    </form>
</div>

<!-- Disk Selection Modal -->
<div id="disk-modal" style="display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background-color: var(--cds-color-white); border-radius: var(--cds-border-radius); padding: var(--cds-spacing-6); max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--cds-spacing-4);">
            <h3 style="font-size: var(--cds-font-size-xl); font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100); margin: 0;">Select Disks to Monitor</h3>
            <button onclick="closeDiskModal()" style="background: none; border: none; font-size: var(--cds-font-size-xl); color: var(--cds-color-gray-70); cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">×</button>
        </div>
        <div id="disk-modal-list">
            {% for mount_point, info in disk_data.items %}
            <label style="display: flex; align-items: center; gap: var(--cds-spacing-2); padding: var(--cds-spacing-2); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius); margin-bottom: var(--cds-spacing-2); cursor: pointer;">
                <input type="checkbox" value="{{ mount_point }}" {% if mount_point in monitored_disks %}checked{% endif %} {% if mount_point == "/" %}disabled{% endif %}>
                <div style="flex: 1;">
                    <div style="font-weight: var(--cds-font-weight-medium); color: var(--cds-color-gray-100);">{{ mount_point }}</div>
                    <div style="font-size: var(--cds-font-size-xs); color: var(--cds-color-gray-70);">{{ info.total|filesizeformat }} total</div>
                </div>
            </label>
            {% endfor %}
        </div>
        <div style="display: flex; justify-content: flex-end; gap: var(--cds-spacing-2); margin-top: var(--cds-spacing-4);">
            <button onclick="closeDiskModal()" style="padding: var(--cds-spacing-2) var(--cds-spacing-4); font-size: var(--cds-font-size-sm); font-weight: var(--cds-font-weight-medium); color: var(--cds-color-gray-100); background-color: var(--cds-color-white); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius); cursor: pointer;">Cancel</button>
            <button onclick="saveDiskSelection()" style="padding: var(--cds-spacing-2) var(--cds-spacing-4); font-size: var(--cds-font-size-sm); font-weight: var(--cds-font-weight-medium); color: var(--cds-color-white); background-color: var(--cds-color-blue-60); border: none; border-radius: var(--cds-border-radius); cursor: pointer;">Save</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extrajs %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="{% static 'core/js/components/server/SLOConfiguration.js' %}"></script>
<script>
    const serverId = document.getElementById('server-id').value;
    let refreshInterval;
    let cpuMemoryChart, diskIOChart, networkIOChart;
    
    // Initialize charts
    document.addEventListener('DOMContentLoaded', function() {
        loadTopProcesses();
        loadServices('enabled');
        initializeCharts();
        // Initialize SLO Configuration
        if (typeof window.initSLOConfiguration !== 'undefined') {
            window.initSLOConfiguration(serverId);
        }
        fetchMetrics();
        
        const toggle = document.getElementById('auto-refresh-toggle');
        if (toggle && toggle.checked) startPolling();
        
        if (toggle) {
            toggle.addEventListener('change', function(e) {
                if (e.target.checked) startPolling();
                else stopPolling();
            });
        }
        
        document.getElementById('thresholds-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            saveThresholds();
        });
    });
    
    function startPolling() {
        fetchMetrics();
        refreshInterval = setInterval(fetchMetrics, 5000);
    }
    
    function stopPolling() {
        if (refreshInterval) clearInterval(refreshInterval);
    }
    
    async function fetchMetrics() {
        try {
            const [metricsRes, diskIORes, networkIORes] = await Promise.all([
                fetch(`/api/server/${serverId}/metrics/?range=1h`),
                fetch(`/api/server/${serverId}/disk-io/?range=1h`),
                fetch(`/api/server/${serverId}/network-io/?range=1h`)
            ]);
            
            if (!metricsRes.ok) throw new Error(`HTTP error! status: ${metricsRes.status}`);
            
            const metricsData = await metricsRes.json();
            const diskIOData = diskIORes.ok ? await diskIORes.json() : { read: [], write: [] };
            const networkIOData = networkIORes.ok ? await networkIORes.json() : { sent: [], recv: [] };
            
            // Update CPU
            if (metricsData.cpu && metricsData.cpu.length > 0) {
                const latest = metricsData.cpu[metricsData.cpu.length - 1];
                document.getElementById('cpu-percent').textContent = Math.round(latest.value) + '%';
            }
            
            // Combine data for charts - match timestamps
            const diskIO = [];
            if (diskIOData.read && diskIOData.write) {
                const readMap = new Map(diskIOData.read.map(r => [r.timestamp, r.value]));
                diskIOData.write.forEach(w => {
                    diskIO.push({
                        timestamp: w.timestamp,
                        read: readMap.get(w.timestamp) || 0,
                        write: w.value || 0
                    });
                });
            }
            
            const networkIO = [];
            if (networkIOData.sent && networkIOData.recv) {
                const sentMap = new Map(networkIOData.sent.map(s => [s.timestamp, s.value]));
                networkIOData.recv.forEach(r => {
                    networkIO.push({
                        timestamp: r.timestamp,
                        tx: sentMap.get(r.timestamp) || 0,
                        rx: r.value || 0
                    });
                });
            }
            
            const chartData = {
                ...metricsData,
                disk_io: diskIO,
                network: networkIO
            };
            
            // Update charts
            updateCharts(chartData);
            
            // Update server status
            if (metricsData.status) {
                updateServerStatus(metricsData.status);
            }
            
        } catch (e) {
            console.error('Error fetching metrics:', e);
            // On error, show offline status
            updateServerStatus('offline');
        }
    }
    
    function updateServerStatus(status) {
        const statusElement = document.getElementById('server-status-text');
        if (!statusElement) return;
        
        // Remove any existing status classes from parent
        statusElement.className = '';
        
        if (status === 'online') {
            statusElement.textContent = 'Online';
            statusElement.style.color = '#166534';
        } else if (status === 'warning') {
            statusElement.textContent = 'Warning';
            statusElement.style.color = '#92400e';
        } else {
            statusElement.textContent = 'Offline';
            statusElement.style.color = '#991b1b';
        }
    }
    
    async function loadTopProcesses() {
        try {
            const [cpuRes, ramRes] = await Promise.all([
                fetch(`/api/server/${serverId}/top-processes/`),
                fetch(`/api/server/${serverId}/top-ram-processes/`)
            ]);
            
            if (cpuRes.ok) {
                const cpuData = await cpuRes.json();
                displayTopProcesses('top-cpu-processes', cpuData.processes || []);
            }
            
            if (ramRes.ok) {
                const ramData = await ramRes.json();
                displayTopProcesses('top-ram-processes', ramData.processes || []);
            }
        } catch (e) {
            console.error('Error loading top processes:', e);
        }
    }
    
    function displayTopProcesses(containerId, processes) {
        const container = document.getElementById(containerId);
        if (!processes || processes.length === 0) {
            container.innerHTML = '<div style="padding: var(--cds-spacing-2); background-color: var(--cds-color-gray-10); border-radius: var(--cds-border-radius);">No data available</div>';
            return;
        }
        
        container.innerHTML = processes.map(p => `
            <div style="display: flex; justify-content: space-between; padding: var(--cds-spacing-2); background-color: var(--cds-color-gray-10); border-radius: var(--cds-border-radius); margin-bottom: var(--cds-spacing-1);">
                <div style="flex: 1;">
                    <div style="font-weight: var(--cds-font-weight-medium); color: var(--cds-color-gray-100);">${p.name || p.command || 'Unknown'}</div>
                    <div style="font-size: var(--cds-font-size-xs); color: var(--cds-color-gray-70);">PID: ${p.pid || 'N/A'}</div>
                </div>
                <div style="font-weight: var(--cds-font-weight-semibold); color: var(--cds-color-gray-100);">${p.usage || 0}%</div>
            </div>
        `).join('');
    }
    
    async function loadServices(filter) {
        try {
            currentFilter = filter;  // Store current filter
            
            // Show loading indicator
            const container = document.getElementById('services-list');
            if (container) {
                container.innerHTML = '<div style="padding: var(--cds-spacing-4); text-align: center; color: var(--cds-color-gray-70);"><div style="display: inline-block; width: 20px; height: 20px; border: 3px solid var(--cds-color-gray-20); border-top-color: var(--cds-color-blue-60); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px;"></div>Loading...</div>';
            }
            
            const res = await fetch(`/api/server/${serverId}/services/`);
            if (!res.ok) throw new Error('Failed to load services');
            
            const data = await res.json();
            let services = [];
            
            // Get services based on filter
            if (filter === 'enabled') {
                // Get monitored services (services with monitoring enabled)
                services = data.monitored || [];
            } else if (filter === 'critical') {
                // Get critical services (monitored + pattern-matched critical services)
                services = data.critical || [];
            } else if (filter === 'all') {
                // Get all services
                services = data.all || [];
            }
            
            displayServices(services);
            
            // Update button states
            document.querySelectorAll('[id^="btn-"]').forEach(btn => {
                btn.style.backgroundColor = 'var(--cds-color-white)';
                btn.style.color = 'var(--cds-color-gray-100)';
            });
            const btn = document.getElementById(`btn-${filter}`);
            if (btn) {
                btn.style.backgroundColor = 'var(--cds-color-blue-60)';
                btn.style.color = 'var(--cds-color-white)';
            }
            
        } catch (e) {
            console.error('Error loading services:', e);
            const container = document.getElementById('services-list');
            if (container) {
                container.innerHTML = '<div style="padding: var(--cds-spacing-4); text-align: center; color: var(--cds-color-red-60);">Error loading services: ' + e.message + '</div>';
            }
        }
    }
    
    let currentFilter = 'enabled';  // Track current filter
    
    function showServices(filter) {
        loadServices(filter);
    }
    
    function displayServices(services) {
        const container = document.getElementById('services-list');
        if (!container) {
            console.error('Services list container not found');
            return;
        }
        
        if (!services || services.length === 0) {
            container.innerHTML = '<div style="padding: var(--cds-spacing-4); text-align: center; color: var(--cds-color-gray-70);">No services found</div>';
            return;
        }
        
        container.innerHTML = services.map(s => {
            const status = s.status || 'unknown';
            const statusColor = status === 'running' ? 'background-color: #dcfce7; color: #166534;' : 
                               status === 'failed' ? 'background-color: #fee2e2; color: #991b1b;' :
                               'background-color: #f3f4f6; color: #6b7280;';
            const isCritical = s.is_critical || false;
            const monitoringEnabled = s.monitoring_enabled || false;
            const serviceId = s.id || null;
            
            // Show Enable/Disable button only for Critical and All filters
            const showToggleButton = (currentFilter === 'critical' || currentFilter === 'all') && serviceId;
            const toggleButton = showToggleButton ? `
                <button onclick="toggleServiceMonitoring(${serviceId}, ${!monitoringEnabled})" 
                        style="padding: var(--cds-spacing-1) var(--cds-spacing-2); font-size: var(--cds-font-size-xs); font-weight: var(--cds-font-weight-medium); 
                               ${monitoringEnabled ? 'background-color: #dc2626; color: #ffffff;' : 'background-color: #22c55e; color: #ffffff;'} 
                               border: none; border-radius: var(--cds-border-radius); cursor: pointer;">
                    ${monitoringEnabled ? 'Disable' : 'Enable'} Monitoring
                </button>
            ` : '';
            
            return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--cds-spacing-3); border: 1px solid var(--cds-color-gray-20); border-radius: var(--cds-border-radius); margin-bottom: var(--cds-spacing-2);">
                <div style="flex: 1;">
                    <div style="font-weight: var(--cds-font-weight-medium); color: var(--cds-color-gray-100);">${s.name || 'Unknown'}</div>
                    <div style="font-size: var(--cds-font-size-xs); color: var(--cds-color-gray-70);">${s.description || s.status || 'Unknown'}</div>
                </div>
                <div style="display: flex; align-items: center; gap: var(--cds-spacing-2);">
                    <span style="padding: var(--cds-spacing-1) var(--cds-spacing-2); font-size: var(--cds-font-size-xs); font-weight: var(--cds-font-weight-medium); border-radius: var(--cds-border-radius); ${statusColor}">${status}</span>
                    ${isCritical ? '<span style="padding: var(--cds-spacing-1) var(--cds-spacing-2); font-size: var(--cds-font-size-xs); font-weight: var(--cds-font-weight-medium); background-color: #fef3c7; color: #92400e; border-radius: var(--cds-border-radius);">Critical</span>' : ''}
                    ${toggleButton}
                </div>
            </div>
            `;
        }).join('');
    }
    
    async function toggleServiceMonitoring(serviceId, enable) {
        try {
            // Show loading state on the button
            const toggleBtn = document.getElementById(`toggle-btn-${serviceId}`);
            if (toggleBtn) {
                const originalText = toggleBtn.textContent;
                toggleBtn.disabled = true;
                toggleBtn.style.opacity = '0.6';
                toggleBtn.style.cursor = 'not-allowed';
                toggleBtn.innerHTML = '<div style="display: inline-block; width: 12px; height: 12px; border: 2px solid #ffffff; border-top-color: transparent; border-radius: 50%; animation: spin 0.6s linear infinite; margin-right: 4px;"></div>Loading...';
            }
            
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            const res = await fetch(`/api/server/${serverId}/service/${serviceId}/toggle-monitoring/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            if (!res.ok) throw new Error('Failed to toggle monitoring');
            
            const data = await res.json();
            if (data.success) {
                // Reload services to reflect the change
                loadServices(currentFilter);
            } else {
                // Restore button state on error
                if (toggleBtn) {
                    toggleBtn.disabled = false;
                    toggleBtn.style.opacity = '1';
                    toggleBtn.style.cursor = 'pointer';
                    toggleBtn.textContent = originalText;
                }
                alert('Error: ' + (data.error || 'Failed to toggle monitoring'));
            }
        } catch (e) {
            console.error('Error toggling service monitoring:', e);
            // Restore button state on error
            const toggleBtn = document.getElementById(`toggle-btn-${serviceId}`);
            if (toggleBtn) {
                toggleBtn.disabled = false;
                toggleBtn.style.opacity = '1';
                toggleBtn.style.cursor = 'pointer';
            }
            alert('Error toggling service monitoring: ' + e.message);
        }
    }
    
    function initializeCharts() {
        // CPU & Memory Chart
        const cpuMemoryCtx = document.getElementById('cpu-memory-chart').getContext('2d');
        cpuMemoryChart = new Chart(cpuMemoryCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'CPU %', data: [], borderColor: '#0ea5e9', backgroundColor: 'rgba(14, 165, 233, 0.1)' },
                    { label: 'Memory %', data: [], borderColor: '#22c55e', backgroundColor: 'rgba(34, 197, 94, 0.1)' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: true } },
                scales: { y: { beginAtZero: true, max: 100 } }
            }
        });
        
        // Disk I/O Chart
        const diskIOCtx = document.getElementById('disk-io-chart').getContext('2d');
        diskIOChart = new Chart(diskIOCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Read (KB/s)', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)' },
                    { label: 'Write (KB/s)', data: [], borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: true } }
            }
        });
        
        // Network I/O Chart
        const networkIOCtx = document.getElementById('network-io-chart').getContext('2d');
        networkIOChart = new Chart(networkIOCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'In (KB/s)', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)' },
                    { label: 'Out (KB/s)', data: [], borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: true } }
            }
        });
    }
    
    function updateCharts(data) {
        // Update CPU & Memory chart
        if (data.cpu && data.memory && data.cpu.length > 0) {
            const timestamps = data.cpu.map(d => {
                const date = new Date(d.timestamp);
                return date.toLocaleTimeString();
            });
            cpuMemoryChart.data.labels = timestamps;
            cpuMemoryChart.data.datasets[0].data = data.cpu.map(d => d.value);
            cpuMemoryChart.data.datasets[1].data = data.memory.map(d => d.value);
            cpuMemoryChart.update('none');
        }
        
        // Update Disk I/O chart
        if (data.disk_io && data.disk_io.length > 0) {
            const timestamps = data.disk_io.map(d => {
                const date = new Date(d.timestamp);
                return date.toLocaleTimeString();
            });
            diskIOChart.data.labels = timestamps;
            diskIOChart.data.datasets[0].data = data.disk_io.map(d => (d.read || 0) / 1024);
            diskIOChart.data.datasets[1].data = data.disk_io.map(d => (d.write || 0) / 1024);
            diskIOChart.update('none');
        }
        
        // Update Network I/O chart
        if (data.network && data.network.length > 0) {
            const timestamps = data.network.map(d => {
                const date = new Date(d.timestamp);
                return date.toLocaleTimeString();
            });
            networkIOChart.data.labels = timestamps;
            networkIOChart.data.datasets[0].data = data.network.map(d => (d.rx || 0) / 1024);
            networkIOChart.data.datasets[1].data = data.network.map(d => (d.tx || 0) / 1024);
            networkIOChart.update('none');
        }
    }
    
    function openDiskModal() {
        document.getElementById('disk-modal').style.display = 'flex';
    }
    
    function closeDiskModal() {
        document.getElementById('disk-modal').style.display = 'none';
    }
    
    async function saveDiskSelection() {
        const checkboxes = document.querySelectorAll('#disk-modal-list input[type="checkbox"]:not([disabled])');
        const selectedDisks = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        
        // Always include / if not already selected
        if (!selectedDisks.includes('/')) {
            selectedDisks.unshift('/');
        }
        
        try {
            const res = await fetch(`/api/server/${serverId}/monitored-disks/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') || ''
                },
                body: JSON.stringify({ disks: selectedDisks })
            });
            
            if (res.ok) {
                const result = await res.json();
                if (result.success) {
                    // Reload the page to show updated disk list
                    location.reload();
                } else {
                    alert('Failed to save disk selection: ' + (result.error || 'Unknown error'));
                }
            } else {
                alert('Failed to save disk selection');
            }
        } catch (e) {
            console.error('Error saving disk selection:', e);
            alert('Error saving disk selection');
        }
    }
    
    async function saveThresholds() {
        const form = document.getElementById('thresholds-form');
        const formData = new FormData(form);
        const data = {};
        for (let [key, value] of formData.entries()) {
            data[key] = parseFloat(value);
        }
        
        try {
            const res = await fetch(`/api/server/${serverId}/thresholds/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') || ''
                },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                const result = await res.json();
                if (result.success) {
                    alert('Thresholds saved successfully');
                } else {
                    alert('Failed to save thresholds: ' + (result.error || 'Unknown error'));
                }
            } else {
                alert('Failed to save thresholds');
            }
        } catch (e) {
            console.error('Error saving thresholds:', e);
            alert('Error saving thresholds');
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
