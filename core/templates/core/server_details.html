{% extends "core/base.html" %}
{% load static %}
{% load rbac_tags %}

{% block title %}Server Details - {{ server.name }} - StackWatch{% endblock %}

{% block bodyclass %}server-details-page{% endblock %}

{% block content %}
<div class="page-content">
    <div class="page-header">
        <div class="page-breadcrumb">
            <a href="{% url 'monitoring_dashboard' %}" class="breadcrumb-link">Dashboard</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current">{{ server.name }}</span>
        </div>
        <h1 class="page-title">{{ server.name }}</h1>
        <p style="font-size: var(--font-size-body); color: var(--color-neutral-text-secondary); margin: var(--spacing-xs) 0 0 0;">{{ server.ip_address }}{% if server.port and server.port != 22 %}:{{ server.port }}{% endif %}</p>
    </div>

    {% if server.monitoring_config.suspend_monitoring %}
    <!-- Monitoring Suspended Banner -->
    <div style="background-color: var(--color-support-warning); color: var(--color-neutral-ui-background); padding: var(--spacing-lg); border-radius: var(--border-radius-card); margin-bottom: var(--spacing-xl); display: flex; align-items: center; gap: var(--spacing-md);">
        <svg fill="currentColor" viewBox="0 0 20 20" style="width: 24px; height: 24px; flex-shrink: 0;">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
        <div>
            <div style="font-size: var(--font-size-body); font-weight: var(--font-weight-semibold); margin-bottom: var(--spacing-xs);">Monitoring is suspended for this server</div>
            <div style="font-size: var(--font-size-caption);">Metrics collection and anomaly detection are currently disabled</div>
        </div>
    </div>
    {% endif %}

    <!-- 1. Anomaly & Metrics Header Section -->
    <section style="margin-bottom: var(--spacing-3xl);">
        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: var(--spacing-xl);">

            <!-- Anomaly Detection Summary Block -->
            <div style="background-color: var(--color-neutral-ui-background); border: 1px solid var(--color-neutral-ui-border-subtle); border-radius: var(--border-radius-card); padding: var(--spacing-xl);">
                <h3 style="font-size: var(--font-size-heading-md); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary); margin: 0 0 var(--spacing-lg) 0; line-height: var(--line-height-heading-md);">Anomaly Status</h3>

                <div class="anomaly-status" data-server-id="{{ server.id }}">
                    <span class="severity-label">Loading...</span>
                    <span class="active-count"></span>
                </div>
            </div>

            <!-- Metrics Graph Placeholder -->
            <div style="background-color: var(--color-neutral-ui-background); border: 1px solid var(--color-neutral-ui-border-subtle); border-radius: var(--border-radius-card); padding: var(--spacing-xl);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--spacing-lg);">
                    <h3 style="font-size: var(--font-size-heading-md); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary); margin: 0; line-height: var(--line-height-heading-md);">System Metrics</h3>
                    <div style="display: flex; gap: var(--spacing-sm);">
                        <button class="metric-time-filter active" data-period="1h">1H</button>
                        <button class="metric-time-filter" data-period="24h">24H</button>
                        <button class="metric-time-filter" data-period="7d">7D</button>
                        <button class="metric-time-filter" data-period="30d">30D</button>
                    </div>
                </div>

                <div id="metrics-chart" style="height: 200px; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text-secondary);">
                    {% if server.monitoring_config.suspend_monitoring %}
                        <div style="text-align: center;">
                            <svg fill="currentColor" viewBox="0 0 20 20" style="width: 48px; height: 48px; margin: 0 auto var(--spacing-md) auto; opacity: 0.5;">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"/>
                            </svg>
                            <p>No data during suspended monitoring</p>
                        </div>
                    {% else %}
                        <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                            <div style="width: 48px; height: 48px; opacity: 0.5;">
                                <svg class="animate-spin" fill="currentColor" viewBox="0 0 20 20" style="width: 48px; height: 48px;">
                                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>

    <!-- 2. Hardware Resource Details Section -->
    <section style="margin-bottom: var(--spacing-3xl);">
        <h2 style="font-size: var(--font-size-heading-lg); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary); margin: 0 0 var(--spacing-xl) 0; line-height: var(--line-height-heading-lg);">Hardware Resources</h2>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-xl);">

            <!-- CPU Card -->
            <div class="resource-card">
                <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                    <div style="width: 48px; height: 48px; background-color: rgba(36, 168, 72, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <svg fill="currentColor" viewBox="0 0 20 20" style="width: 24px; height: 24px; color: var(--color-support-success);">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h4 style="font-size: var(--font-size-heading-sm); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary); margin: 0; line-height: var(--line-height-heading-sm);">CPU</h4>
                        <p style="font-size: var(--font-size-caption); color: var(--color-neutral-text-secondary); margin: var(--spacing-xs) 0 0 0;">Processor usage and cores</p>
                    </div>
                </div>

                {% if latest_metric %}
                <div style="space-y: var(--spacing-lg);">
                    <div class="metric-item">
                        <span class="metric-label">Usage</span>
                        <span class="metric-value">{{ latest_metric.cpu_load_avg_1m|floatformat:1 }}%</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Load Average</span>
                        <span class="metric-value">{{ latest_metric.cpu_load_avg_1m|floatformat:2 }}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Cores</span>
                        <span class="metric-value">{{ server.cpu_cores|default:"—" }}</span>
                    </div>
                </div>
                {% else %}
                <div style="color: var(--color-neutral-text-secondary); font-style: italic;">No CPU data available</div>
                {% endif %}
            </div>

            <!-- Memory Card -->
            <div class="resource-card">
                <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                    <div style="width: 48px; height: 48px; background-color: rgba(59, 130, 246, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <svg fill="currentColor" viewBox="0 0 20 20" style="width: 24px; height: 24px; color: #3b82f6;">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div>
                        <h4 style="font-size: var(--font-size-heading-sm); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary); margin: 0; line-height: var(--line-height-heading-sm);">Memory</h4>
                        <p style="font-size: var(--font-size-caption); color: var(--color-neutral-text-secondary); margin: var(--spacing-xs) 0 0 0;">RAM usage and swap</p>
                    </div>
                </div>

                {% if latest_metric %}
                <div style="space-y: var(--spacing-lg);">
                    <div class="metric-item">
                        <span class="metric-label">Used</span>
                        <span class="metric-value">{{ latest_metric.memory_used|filesizeformat }} / {{ latest_metric.memory_total|filesizeformat }}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Percentage</span>
                        <span class="metric-value">{{ latest_metric.memory_percent|floatformat:1 }}%</span>
                    </div>
                    {% if latest_metric.swap_total and latest_metric.swap_total > 0 %}
                    <div class="metric-item">
                        <span class="metric-label">Swap</span>
                        <span class="metric-value">{{ latest_metric.swap_used|filesizeformat }} / {{ latest_metric.swap_total|filesizeformat }}</span>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div style="color: var(--color-neutral-text-secondary); font-style: italic;">No memory data available</div>
                {% endif %}
            </div>

            <!-- Disk Card -->
            <div class="resource-card">
                <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                    <div style="width: 48px; height: 48px; background-color: rgba(245, 158, 11, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <svg fill="currentColor" viewBox="0 0 20 20" style="width: 24px; height: 24px; color: var(--color-support-warning);">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div>
                        <h4 style="font-size: var(--font-size-heading-sm); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary); margin: 0; line-height: var(--line-height-heading-sm);">Disk</h4>
                        <p style="font-size: var(--font-size-caption); color: var(--color-neutral-text-secondary); margin: var(--spacing-xs) 0 0 0;">Storage usage and partitions</p>
                    </div>
                </div>

                {% if disk_summary.partitions %}
                <div style="space-y: var(--spacing-lg);">
                    {% for partition in disk_summary.partitions|slice:":3" %}
                    <div class="metric-item">
                        <span class="metric-label">{{ partition.mount_point }}</span>
                        <span class="metric-value">{{ partition.used|filesizeformat }} / {{ partition.total|filesizeformat }}</span>
                    </div>
                    {% endfor %}
                    {% if disk_summary.partitions|length > 3 %}
                    <div style="font-size: var(--font-size-caption); color: var(--color-neutral-text-secondary); margin-top: var(--spacing-sm);">
                        +{{ disk_summary.partitions|length|add:"-3" }} more partitions
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div style="color: var(--color-neutral-text-secondary); font-style: italic;">No disk data available</div>
                {% endif %}
            </div>

            <!-- Network Card -->
            <div class="resource-card">
                <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                    <div style="width: 48px; height: 48px; background-color: rgba(168, 85, 247, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <svg fill="currentColor" viewBox="0 0 20 20" style="width: 24px; height: 24px; color: #a855f7;">
                            <path fill-rule="evenodd" d="M2 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 002 2H4a2 2 0 01-2-2V5zm3 1h6v4H5V6zm6 6H5v2h6v-2z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div>
                        <h4 style="font-size: var(--font-size-heading-sm); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary); margin: 0; line-height: var(--line-height-heading-sm);">Network</h4>
                        <p style="font-size: var(--font-size-caption); color: var(--color-neutral-text-secondary); margin: var(--spacing-xs) 0 0 0;">Interface traffic and throughput</p>
                    </div>
                </div>

                {% if latest_metric and latest_metric.network_interfaces %}
                <div style="space-y: var(--spacing-lg);">
                    {% for interface, data in latest_metric.network_interfaces.items %}
                    {% if forloop.first %}
                    <div class="metric-item">
                        <span class="metric-label">{{ interface }}</span>
                        <span class="metric-value">{{ data.rx_bytes|filesizeformat }}/s RX</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">{{ interface }}</span>
                        <span class="metric-value">{{ data.tx_bytes|filesizeformat }}/s TX</span>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <div style="color: var(--color-neutral-text-secondary); font-style: italic;">No network data available</div>
                {% endif %}
            </div>

        </div>
    </section>

    <!-- 3. Services Section (Restructured) -->
    <section style="margin-bottom: var(--spacing-3xl);">
        <h2 style="font-size: var(--font-size-heading-lg); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary); margin: 0 0 var(--spacing-xl) 0; line-height: var(--line-height-heading-lg);">Service Monitoring</h2>

        <!-- Service Status Overview -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-lg); margin-bottom: var(--spacing-2xl);">
            <div class="structured-list-item">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: var(--font-size-body); color: var(--color-neutral-text-secondary);">Monitored Services</span>
                    <span id="monitored-count" style="font-size: var(--font-size-body-large); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary);">—</span>
                </div>
            </div>
            <div class="structured-list-item">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: var(--font-size-body); color: var(--color-neutral-text-secondary);">Total Services</span>
                    <span id="total-count" style="font-size: var(--font-size-body-large); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary);">—</span>
                </div>
            </div>
            <div class="structured-list-item">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: var(--font-size-body); color: var(--color-neutral-text-secondary);">Running</span>
                    <span id="running-count-overview" style="font-size: var(--font-size-body-large); font-weight: var(--font-weight-semibold); color: var(--color-support-success);">—</span>
                </div>
            </div>
            <div class="structured-list-item">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: var(--font-size-body); color: var(--color-neutral-text-secondary);">Failed</span>
                    <span id="failed-count-overview" style="font-size: var(--font-size-body-large); font-weight: var(--font-weight-semibold); color: var(--color-support-error);">—</span>
                </div>
            </div>
        </div>

        <!-- Service Tabs -->
        <div style="background-color: var(--color-neutral-ui-background); border: 1px solid var(--color-neutral-ui-border-subtle); border-radius: var(--border-radius-card); overflow: hidden; margin-bottom: var(--spacing-xl);">
            <div style="border-bottom: 1px solid var(--color-neutral-ui-border-subtle);">
                <div style="display: flex; gap: 0;">
                    <button class="service-tab active" data-tab="critical" style="padding: var(--spacing-md) var(--spacing-lg); border: none; background: none; border-bottom: 2px solid var(--color-primary-interactive); font-size: var(--font-size-body); font-weight: var(--font-weight-medium); color: var(--color-primary-interactive); cursor: pointer; transition: all 150ms ease;">
                        Critical Services <span id="critical-count" class="tab-count">(0)</span>
                    </button>
                    <button class="service-tab" data-tab="enabled" style="padding: var(--spacing-md) var(--spacing-lg); border: none; background: none; border-bottom: 2px solid transparent; font-size: var(--font-size-body); font-weight: var(--font-weight-medium); color: var(--color-neutral-text-secondary); cursor: pointer; transition: all 150ms ease;">
                        Enabled Services <span id="enabled-count" class="tab-count">(0)</span>
                    </button>
                    <button class="service-tab" data-tab="all" style="padding: var(--spacing-md) var(--spacing-lg); border: none; background: none; border-bottom: 2px solid transparent; font-size: var(--font-size-body); font-weight: var(--font-weight-medium); color: var(--color-neutral-text-secondary); cursor: pointer; transition: all 150ms ease;">
                        All Services <span id="all-count" class="tab-count">(0)</span>
                    </button>
                </div>
            </div>

            <!-- Service Content with Scrolling -->
            <div id="service-content" style="max-height: 400px; overflow-y: auto;">
                <!-- Services will be loaded here -->
                <div style="padding: var(--spacing-2xl); text-align: center;">
                    <div style="width: 48px; height: 48px; margin: 0 auto var(--spacing-lg) auto; opacity: 0.5;">
                        <svg class="animate-spin" fill="currentColor" viewBox="0 0 20 20" style="width: 48px; height: 48px;">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <p style="font-size: var(--font-size-body); color: var(--color-neutral-text-secondary); margin: 0;">Loading services...</p>
                </div>
            </div>
        </div>

        <!-- Service Actions -->
        <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end;">
            <button id="refresh-services-btn" class="btn" style="background-color: var(--color-neutral-ui-background); color: var(--color-neutral-text-primary); border: 1px solid var(--color-neutral-ui-border-strong); padding: var(--spacing-sm) var(--spacing-lg); font-size: var(--font-size-body); font-weight: var(--font-weight-medium); border-radius: var(--border-radius-control); cursor: pointer;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px; margin-right: var(--spacing-xs);">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Refresh
            </button>
        </div>
    </section>

    <!-- 4. Threshold Settings Section -->
    <section>
        <h2 style="font-size: var(--font-size-heading-lg); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary); margin: 0 0 var(--spacing-xl) 0; line-height: var(--line-height-heading-lg);">Alert Thresholds</h2>

        <div style="background-color: var(--color-neutral-ui-background); border: 1px solid var(--color-neutral-ui-border-subtle); border-radius: var(--border-radius-card); padding: var(--spacing-2xl);">
            <form id="thresholds-form">
                {% csrf_token %}
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-xl);">

                    <!-- CPU Alert Threshold -->
                    <div>
                        <label for="cpu-threshold" style="display: block; font-size: var(--font-size-label); font-weight: var(--font-weight-regular); color: var(--color-neutral-text-primary); margin-bottom: var(--spacing-xs); line-height: var(--line-height-caption);">CPU Usage Threshold (%)</label>
                        <input type="number" id="cpu-threshold" name="cpu_threshold" min="1" max="100" value="{{ server.monitoring_config.cpu_alert_threshold|default:80 }}"
                               style="width: 100%; padding: var(--spacing-sm) var(--spacing-md); font-size: var(--font-size-body); font-family: var(--font-family-primary); color: var(--color-neutral-text-primary); background-color: var(--color-neutral-ui-background); border: 1px solid var(--color-neutral-ui-border-strong); border-radius: var(--border-radius-control); transition: all 150ms ease;">
                        <div style="font-size: var(--font-size-caption); color: var(--color-neutral-text-secondary); margin-top: var(--spacing-xs); line-height: var(--line-height-caption);">
                            Alert when CPU usage exceeds this percentage
                        </div>
                    </div>

                    <!-- Memory Alert Threshold -->
                    <div>
                        <label for="memory-threshold" style="display: block; font-size: var(--font-size-label); font-weight: var(--font-weight-regular); color: var(--color-neutral-text-primary); margin-bottom: var(--spacing-xs); line-height: var(--line-height-caption);">Memory Usage Threshold (%)</label>
                        <input type="number" id="memory-threshold" name="memory_threshold" min="1" max="100" value="{{ server.monitoring_config.memory_alert_threshold|default:85 }}"
                               style="width: 100%; padding: var(--spacing-sm) var(--spacing-md); font-size: var(--font-size-body); font-family: var(--font-family-primary); color: var(--color-neutral-text-primary); background-color: var(--color-neutral-ui-background); border: 1px solid var(--color-neutral-ui-border-strong); border-radius: var(--border-radius-control); transition: all 150ms ease;">
                        <div style="font-size: var(--font-size-caption); color: var(--color-neutral-text-secondary); margin-top: var(--spacing-xs); line-height: var(--line-height-caption);">
                            Alert when memory usage exceeds this percentage
                        </div>
                    </div>

                    <!-- Disk Usage Threshold -->
                    <div>
                        <label for="disk-threshold" style="display: block; font-size: var(--font-size-label); font-weight: var(--font-weight-regular); color: var(--color-neutral-text-primary); margin-bottom: var(--spacing-xs); line-height: var(--line-height-caption);">Disk Usage Threshold (%)</label>
                        <input type="number" id="disk-threshold" name="disk_threshold" min="1" max="100" value="{{ server.monitoring_config.disk_alert_threshold|default:90 }}"
                               style="width: 100%; padding: var(--spacing-sm) var(--spacing-md); font-size: var(--font-size-body); font-family: var(--font-family-primary); color: var(--color-neutral-text-primary); background-color: var(--color-neutral-ui-background); border: 1px solid var(--color-neutral-ui-border-strong); border-radius: var(--border-radius-control); transition: all 150ms ease;">
                        <div style="font-size: var(--font-size-caption); color: var(--color-neutral-text-secondary); margin-top: var(--spacing-xs); line-height: var(--line-height-caption);">
                            Alert when disk usage exceeds this percentage
                        </div>
                    </div>

                    <!-- Network Spike Threshold -->
                    <div>
                        <label for="network-threshold" style="display: block; font-size: var(--font-size-label); font-weight: var(--font-weight-regular); color: var(--color-neutral-text-primary); margin-bottom: var(--spacing-xs); line-height: var(--line-height-caption);">Network Spike Threshold (MB/s)</label>
                        <input type="number" id="network-threshold" name="network_threshold" min="1" max="10000" value="{{ server.monitoring_config.network_alert_threshold|default:100 }}"
                               style="width: 100%; padding: var(--spacing-sm) var(--spacing-md); font-size: var(--font-size-body); font-family: var(--font-family-primary); color: var(--color-neutral-text-primary); background-color: var(--color-neutral-ui-background); border: 1px solid var(--color-neutral-ui-border-strong); border-radius: var(--border-radius-control); transition: all 150ms ease;">
                        <div style="font-size: var(--font-size-caption); color: var(--color-neutral-text-secondary); margin-top: var(--spacing-xs); line-height: var(--line-height-caption);">
                            Alert when network traffic exceeds this rate
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end; margin-top: var(--spacing-xl);">
                    <button type="submit" class="btn" style="background-color: var(--color-primary-interactive); color: var(--color-neutral-ui-background); padding: var(--spacing-sm) var(--spacing-lg); font-size: var(--font-size-body); font-weight: var(--font-weight-medium); border: none; border-radius: var(--border-radius-control); cursor: pointer;">Save Thresholds</button>
                </div>
            </form>
        </div>
    </section>

        <!-- Service Status Overview -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-lg); margin-bottom: var(--spacing-2xl);">
            <div class="structured-list-item">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: var(--font-size-body); color: var(--color-neutral-text-secondary);">Monitored Services</span>
                    <span id="monitored-count" style="font-size: var(--font-size-body-large); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary);">—</span>
                </div>
            </div>
            <div class="structured-list-item">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: var(--font-size-body); color: var(--color-neutral-text-secondary);">Total Services</span>
                    <span id="total-count" style="font-size: var(--font-size-body-large); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary);">—</span>
                </div>
            </div>
            <div class="structured-list-item">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: var(--font-size-body); color: var(--color-neutral-text-secondary);">Running</span>
                    <span id="running-count-overview" style="font-size: var(--font-size-body-large); font-weight: var(--font-weight-semibold); color: var(--color-support-success);">—</span>
                </div>
            </div>
            <div class="structured-list-item">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: var(--font-size-body); color: var(--color-neutral-text-secondary);">Failed</span>
                    <span id="failed-count-overview" style="font-size: var(--font-size-body-large); font-weight: var(--font-weight-semibold); color: var(--color-support-error);">—</span>
                </div>
            </div>
        </div>

        <!-- Services Table - IBM Carbon DataTable -->
        <div style="background-color: var(--color-neutral-ui-background); border: 1px solid var(--color-neutral-ui-border-subtle); border-radius: var(--border-radius-card); overflow: hidden;">
            <div style="padding: var(--spacing-lg); border-bottom: 1px solid var(--color-neutral-ui-border-subtle);">
                <h3 style="font-size: var(--font-size-heading-md); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary); margin: 0; line-height: var(--line-height-heading-md);">System Services</h3>
                <p style="font-size: var(--font-size-body); color: var(--color-neutral-text-secondary); margin: var(--spacing-xs) 0 0 0; line-height: var(--line-height-body);">Monitor and manage systemd services on this server</p>
            </div>

            <div id="services-table-body">
                <!-- Loading state -->
                <div style="padding: var(--spacing-3xl); text-align: center;">
                    <div style="width: 48px; height: 48px; margin: 0 auto var(--spacing-lg) auto; opacity: 0.5;">
                        <svg class="animate-spin" fill="currentColor" viewBox="0 0 20 20" style="width: 48px; height: 48px;">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <p style="font-size: var(--font-size-body); color: var(--color-neutral-text-secondary); margin: 0;">Loading services...</p>
                </div>
            </div>
        </div>

        <!-- Service Actions -->
        <div style="margin-top: var(--spacing-xl); display: flex; gap: var(--spacing-md); justify-content: flex-end;">
            <button id="refresh-services-btn" class="btn" style="background-color: var(--color-neutral-ui-background); color: var(--color-neutral-text-primary); border: 1px solid var(--color-neutral-ui-border-strong); padding: var(--spacing-sm) var(--spacing-lg); font-size: var(--font-size-body); font-weight: var(--font-weight-medium); border-radius: var(--border-radius-control); cursor: pointer;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px; margin-right: var(--spacing-xs);">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Refresh
            </button>
        </div>
    </section>
</div>
{% endblock %}

{% block extrajs %}
<script>
// Server details functionality
let servicePollingInterval = null;
let anomalyPollingInterval = null;
let currentServiceTab = 'critical';

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('Server details: Initializing...');

    // Initialize all components
    initAnomalyStatus();
    loadServices();
    initServiceTabs();
    initThresholdsForm();
    initTimeFilters();

    // Set up refresh button
    const refreshBtn = document.getElementById('refresh-services-btn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            loadServices();
        });
    }

    // Start polling
    startServicePolling();
    startAnomalyPolling();
});

// Initialize anomaly status
function initAnomalyStatus() {
    // Load initial anomaly status
    updateAnomalyStatus();

    // Set up polling for anomaly updates
    anomalyPollingInterval = setInterval(updateAnomalyStatus, 30000); // 30 seconds
}

// Update anomaly status
async function updateAnomalyStatus() {
    try {
        const response = await fetch(`/api/server/{{ server.id }}/anomaly-status/`);
        const data = await response.json();

        // API returns data directly (not wrapped in success/data)
        const anomalyElement = document.querySelector('.anomaly-status');
        if (anomalyElement) {
            const severityLabel = anomalyElement.querySelector('.severity-label');
            const activeCount = anomalyElement.querySelector('.active-count');

            if (data.active > 0) {
                severityLabel.textContent = data.highest_severity;
                severityLabel.className = 'severity-label';
                activeCount.textContent = `${data.active} active`;
                anomalyElement.className = `anomaly-status anomaly-${data.highest_severity.toLowerCase()}`;
            } else {
                severityLabel.textContent = 'OK';
                severityLabel.className = 'severity-label';
                activeCount.textContent = 'No Active Anomalies';
                anomalyElement.className = 'anomaly-status anomaly-ok';
            }
        }
    } catch (error) {
        console.error('Failed to load anomaly status:', error);
        // Show error state
        const anomalyElement = document.querySelector('.anomaly-status');
        if (anomalyElement) {
            const severityLabel = anomalyElement.querySelector('.severity-label');
            const activeCount = anomalyElement.querySelector('.active-count');
            if (severityLabel) severityLabel.textContent = 'Error';
            if (activeCount) activeCount.textContent = 'Unable to load';
            anomalyElement.className = 'anomaly-status anomaly-unknown';
        }
    }
}

// Initialize service tabs
function initServiceTabs() {
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.dataset.tab;

            // Update active tab
            document.querySelectorAll('.service-tab').forEach(t => {
                t.classList.remove('active');
                t.style.borderBottomColor = 'transparent';
                t.style.color = 'var(--color-neutral-text-secondary)';
            });

            this.classList.add('active');
            this.style.borderBottomColor = 'var(--color-primary-interactive)';
            this.style.color = 'var(--color-primary-interactive)';

            currentServiceTab = tabName;
            loadServices();
        });
    });
}

// Initialize time filters (placeholder for future chart implementation)
function initTimeFilters() {
    document.querySelectorAll('.metric-time-filter').forEach(filter => {
        filter.addEventListener('click', function() {
            document.querySelectorAll('.metric-time-filter').forEach(f => f.classList.remove('active'));
            this.classList.add('active');

            // TODO: Implement chart time filtering when chart library is added
            console.log('Time filter changed to:', this.dataset.period);
        });
    });
}

// Load services from API
async function loadServices() {
    console.log('Service monitoring: Loading services...');
    const serviceContent = document.getElementById('service-content');

    // Show loading state
    serviceContent.innerHTML = `
        <div style="padding: var(--spacing-3xl); text-align: center;">
            <div style="width: 48px; height: 48px; margin: 0 auto var(--spacing-lg) auto; opacity: 0.5;">
                <svg class="animate-spin" fill="currentColor" viewBox="0 0 20 20" style="width: 48px; height: 48px;">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                </svg>
            </div>
            <p style="font-size: var(--font-size-body); color: var(--color-neutral-text-secondary); margin: 0;">Loading services...</p>
        </div>
    `;

    try {
        const response = await fetch(`/api/server/{{ server.id }}/services/`);
        const data = await response.json();

        if (data.success) {
            console.log('Service monitoring: Data received', data);
            renderServices(data);
            updateOverviewStats(data);
            updateTabCounts(data);
        } else {
            console.error('Service monitoring: API error', data.error);
            showError('Failed to load services: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Service monitoring: Network error', error);
        showError('Network error while loading services');
    }
}

// Render services based on current tab
function renderServices(data) {
    const serviceContent = document.getElementById('service-content');

    if (!data.all || data.all.length === 0) {
        serviceContent.innerHTML = `
            <div style="padding: var(--spacing-3xl); text-align: center; color: var(--color-neutral-text-secondary);">
                <div style="width: 48px; height: 48px; margin: 0 auto var(--spacing-lg) auto; opacity: 0.5;">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <p>No services found on this server.</p>
            </div>
        `;
        return;
    }

    // Filter services based on current tab
    let servicesToShow = [];

    switch (currentServiceTab) {
        case 'critical':
            // Show critical services by default (ssh, nginx, mysql, etc.)
            const criticalServices = ['sshd', 'nginx', 'apache2', 'httpd', 'mysql', 'mariadb', 'redis', 'php-fpm', 'postfix', 'systemd-logind', 'docker', 'cron', 'rsyslog', 'syslog'];
            servicesToShow = data.all.filter(service =>
                criticalServices.includes(service.name) ||
                data.critical.some(c => c.name === service.name)
            );
            break;
        case 'enabled':
            // Show only monitored services
            servicesToShow = data.critical;
            break;
        case 'all':
            // Show all services
            servicesToShow = data.all;
            break;
    }

    if (servicesToShow.length === 0) {
        serviceContent.innerHTML = `
            <div style="padding: var(--spacing-3xl); text-align: center; color: var(--color-neutral-text-secondary);">
                <p>No services in this category.</p>
            </div>
        `;
        return;
    }

    // Sort services: monitored first, then by status, then alphabetically
    const sortedServices = servicesToShow.sort((a, b) => {
        const aMonitored = data.critical.some(s => s.name === a.name);
        const bMonitored = data.critical.some(s => s.name === b.name);

        if (aMonitored !== bMonitored) return bMonitored ? 1 : -1;

        const statusOrder = { 'failed': 0, 'running': 1, 'stopped': 2 };
        const aOrder = statusOrder[a.status] ?? 3;
        const bOrder = statusOrder[b.status] ?? 3;

        if (aOrder !== bOrder) return aOrder - bOrder;

        return a.name.localeCompare(b.name);
    });

    let html = '';
    sortedServices.forEach(service => {
        const isMonitored = data.critical.some(s => s.name === service.name);
        const isCritical = ['sshd', 'nginx', 'apache2', 'httpd', 'mysql', 'mariadb', 'redis', 'php-fpm', 'postfix', 'systemd-logind', 'docker'].includes(service.name);
        const statusClass = getServiceStatusClass(service.status);
        const statusColor = getServiceStatusColor(service.status);

        html += `
            <div style="padding: var(--spacing-lg); border-bottom: 1px solid var(--color-neutral-ui-border-subtle);">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                        <div style="width: 40px; height: 40px; background-color: ${statusColor.background}; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <span style="font-size: var(--font-size-body); font-weight: var(--font-weight-semibold); color: ${statusColor.text};">${service.name.charAt(0).toUpperCase()}</span>
                        </div>
                        <div style="min-width: 0; flex: 1;">
                            <div style="font-size: var(--font-size-body); font-weight: var(--font-weight-medium); color: var(--color-neutral-text-primary); margin-bottom: var(--spacing-xs);">
                                ${service.name}
                                ${isCritical ? '<span style="font-size: var(--font-size-caption); background-color: var(--color-support-error); color: var(--color-neutral-ui-background); padding: 2px 6px; border-radius: 10px; margin-left: var(--spacing-sm);">Critical</span>' : ''}
                                ${isMonitored ? '<span style="font-size: var(--font-size-caption); background-color: var(--color-primary-interactive); color: var(--color-neutral-ui-background); padding: 2px 6px; border-radius: 10px; margin-left: var(--spacing-sm);">Monitored</span>' : ''}
                            </div>
                            <div style="font-size: var(--font-size-caption); color: var(--color-neutral-text-secondary);">
                                ${service.description || 'System service'}
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                        <span class="status ${statusClass}" style="font-size: var(--font-size-caption); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--border-radius-control);">
                            ${service.status.charAt(0).toUpperCase() + service.status.slice(1)}
                        </span>
                        <button onclick="${isMonitored ? 'disableService' : 'enableService'}('${service.name}')" class="btn" style="background-color: ${isMonitored ? 'var(--color-support-error)' : 'var(--color-primary-interactive)'}; color: var(--color-neutral-ui-background); padding: var(--spacing-xs) var(--spacing-sm); font-size: var(--font-size-caption); border: none; border-radius: var(--border-radius-control); cursor: pointer;">${isMonitored ? 'Disable' : 'Enable'}</button>
                    </div>
                </div>
            </div>
        `;
    });

    serviceContent.innerHTML = html;
}

// Update tab counts
function updateTabCounts(data) {
    // Critical services count
    const criticalServices = ['sshd', 'nginx', 'apache2', 'httpd', 'mysql', 'mariadb', 'redis', 'php-fpm', 'postfix', 'systemd-logind', 'docker', 'cron', 'rsyslog', 'syslog'];
    const criticalCount = data.all.filter(service =>
        criticalServices.includes(service.name) ||
        data.critical.some(c => c.name === service.name)
    ).length;

    // Enabled services count
    const enabledCount = data.critical.length;

    // All services count
    const allCount = data.all.length;

    document.getElementById('critical-count').textContent = `(${criticalCount})`;
    document.getElementById('enabled-count').textContent = `(${enabledCount})`;
    document.getElementById('all-count').textContent = `(${allCount})`;
}

// Update overview statistics
function updateOverviewStats(data) {
    document.getElementById('monitored-count').textContent = data.critical.length;
    document.getElementById('total-count').textContent = data.all.length;
    document.getElementById('running-count-overview').textContent = data.running.length;
    document.getElementById('failed-count-overview').textContent = data.failed.length;
}

// Initialize thresholds form
function initThresholdsForm() {
    const form = document.getElementById('thresholds-form');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                cpu_threshold: parseInt(document.getElementById('cpu-threshold').value),
                memory_threshold: parseInt(document.getElementById('memory-threshold').value),
                disk_threshold: parseInt(document.getElementById('disk-threshold').value),
                network_threshold: parseInt(document.getElementById('network-threshold').value)
            };

            try {
                const response = await fetch(`/api/server/{{ server.id }}/thresholds/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Alert thresholds updated successfully', 'success');
                } else {
                    showToast(data.error || 'Failed to update thresholds', 'error');
                }
            } catch (error) {
                console.error('Thresholds update error:', error);
                showToast('Network error occurred', 'error');
            }
        });
    }
}

// Get service status CSS class
function getServiceStatusClass(status) {
    switch (status.toLowerCase()) {
        case 'running':
            return 'status-success';
        case 'failed':
            return 'status-error';
        case 'stopped':
            return 'status-warning';
        default:
            return 'status-info';
    }
}

// Get service status colors
function getServiceStatusColor(status) {
    switch (status.toLowerCase()) {
        case 'running':
            return { background: 'rgba(36, 168, 72, 0.1)', text: 'var(--color-support-success)' };
        case 'failed':
            return { background: 'rgba(218, 30, 40, 0.1)', text: 'var(--color-support-error)' };
        case 'stopped':
            return { background: 'rgba(245, 158, 11, 0.1)', text: 'var(--color-support-warning)' };
        default:
            return { background: 'rgba(107, 114, 128, 0.1)', text: 'var(--color-neutral-text-secondary)' };
    }
}

// Enable service for monitoring
async function enableService(serviceName) {
    try {
        const response = await fetch(`/api/server/{{ server.id }}/services/monitor/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                services: [serviceName]
            })
        });

        const data = await response.json();

        if (data.success) {
            showToast(`Service "${serviceName}" enabled for monitoring`, 'success');
            loadServices(); // Refresh the list
        } else {
            showToast(data.error || 'Failed to enable service', 'error');
        }
    } catch (error) {
        console.error('Enable service error:', error);
        showToast('Network error occurred', 'error');
    }
}

// Disable service from monitoring
async function disableService(serviceName) {
    try {
        const response = await fetch(`/api/server/{{ server.id }}/services/monitor/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                services: [serviceName] // API will remove this from monitored list
            })
        });

        const data = await response.json();

        if (data.success) {
            showToast(`Service "${serviceName}" disabled from monitoring`, 'success');
            loadServices(); // Refresh the list
        } else {
            showToast(data.error || 'Failed to disable service', 'error');
        }
    } catch (error) {
        console.error('Disable service error:', error);
        showToast('Network error occurred', 'error');
    }
}

// Show error state
function showError(message) {
    const tableBody = document.getElementById('services-table-body');
    tableBody.innerHTML = `
        <div style="padding: var(--spacing-3xl); text-align: center; color: var(--color-support-error);">
            <div style="width: 48px; height: 48px; margin: 0 auto var(--spacing-lg) auto; opacity: 0.5;">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
            </div>
            <p style="font-size: var(--font-size-body); margin: 0;">${message}</p>
        </div>
    `;
}

// Start polling for service updates
function startServicePolling() {
    // Poll every 60 seconds for services (less frequent than metrics)
    servicePollingInterval = setInterval(() => {
        loadServices();
    }, 60000);
}

// Start polling for anomaly updates
function startAnomalyPolling() {
    // Poll every 30 seconds for anomaly status (matches dashboard)
    anomalyPollingInterval = setInterval(() => {
        updateAnomalyStatus();
    }, 30000);
}

// Clean up on page unload
window.addEventListener('beforeunload', () => {
    if (servicePollingInterval) {
        clearInterval(servicePollingInterval);
    }
    if (anomalyPollingInterval) {
        clearInterval(anomalyPollingInterval);
    }
});

// Toast notification function (simplified)
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `notification notification-${type}`;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        min-width: 300px;
        max-width: 500px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-radius: var(--border-radius-card);
        background-color: var(--color-neutral-ui-background);
        border: 1px solid var(--color-neutral-ui-border-subtle);
    `;

    const iconColor = type === 'success' ? 'var(--color-support-success)' :
                     type === 'error' ? 'var(--color-support-error)' :
                     'var(--color-primary-interactive)';

    toast.innerHTML = `
        <div class="notification-content" style="padding: var(--spacing-lg);">
            <div style="display: flex; align-items: flex-start; gap: var(--spacing-md);">
                <div class="notification-icon" style="color: ${iconColor};">
                    ${type === 'success' ? `
                        <svg fill="currentColor" viewBox="0 0 20 20" style="width: 20px; height: 20px;">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                    ` : type === 'error' ? `
                        <svg fill="currentColor" viewBox="0 0 20 20" style="width: 20px; height: 20px;">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                    ` : `
                        <svg fill="currentColor" viewBox="0 0 20 20" style="width: 20px; height: 20px;">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                    `}
                </div>
                <div style="flex: 1;">
                    <div style="font-size: var(--font-size-body); font-weight: var(--font-weight-medium); color: var(--color-neutral-text-primary); line-height: var(--line-height-body);">
                        ${message}
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; color: var(--color-neutral-text-secondary); cursor: pointer; padding: var(--spacing-xs);">
                    <svg fill="currentColor" viewBox="0 0 20 20" style="width: 16px; height: 16px;">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
