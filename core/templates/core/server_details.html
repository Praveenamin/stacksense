{% extends "admin/base_site.html" %}
{% load static %}
{% load rbac_tags %}

{% block title %}Server Details - {{ server.name }} - StackWatch{% endblock %}

{% block extrahead %}
<link rel="stylesheet" href="{% static 'core/css/design-system.css' %}">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
{% endblock %}

{% block content %}
<div class="page-wrapper">
    <!-- IBM Carbon UI Shell Header -->
    {% include 'core/header.html' %}

    <!-- IBM Carbon UI Shell Left Panel -->
    {% include 'core/sidebar.html' %}

    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <!-- Page Header - IBM Carbon Layout -->
            <div style="margin-bottom: var(--spacing-3xl);">
                <div style="display: flex; align-items: center; gap: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
                    <a href="/monitoring/" class="btn btn-ghost">
                        <svg style="width: 16px; height: 16px; margin-right: var(--spacing-xs);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                        Back to Dashboard
                    </a>
                </div>

                <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--spacing-2xl); align-items: flex-start;">
                    <div>
                        <h1 style="font-size: var(--font-size-display); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary); margin: 0 0 var(--spacing-sm) 0; line-height: var(--line-height-display);">
                            {{ server.name }}
                        </h1>
                        <p style="font-size: var(--font-size-body-large); color: var(--color-neutral-text-secondary); margin: 0; line-height: var(--line-height-body-large);">
                            {{ server.ip_address }}{% if server.port and server.port != 22 %}:{{ server.port }}{% endif %}
                        </p>
                    </div>

                    <!-- Server Status Tile -->
                    <div class="title-tile">
                        <div style="display: flex; align-items: center; gap: var(--spacing-lg);">
                            <div class="status-indicator status-{{ server_status|lower }}"></div>
                            <div>
                                <div style="font-size: var(--font-size-heading-md); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary); line-height: var(--line-height-heading-md);">
                                    {{ server_status|title }}
                                </div>
                                <div style="font-size: var(--font-size-caption); color: var(--color-neutral-text-secondary); text-transform: uppercase; letter-spacing: 0.16px;">
                                    Server Status
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Health - IBM Carbon Structured List -->
            <section style="margin-bottom: var(--spacing-3xl);">
                <h2 style="font-size: var(--font-size-heading-lg); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary); margin: 0 0 var(--spacing-xl) 0; line-height: var(--line-height-heading-lg);">System Health</h2>

                <div class="card" id="anomaly-summary" data-server-id="{{ server.id }}">
                    <div class="card-header">
                        <h3 class="card-title">Anomaly Detection Status</h3>
                        <p class="card-subtitle">AI-powered monitoring of system metrics</p>
                    </div>
                    <div class="card-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
                            <div class="structured-list-item">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: var(--font-size-body); color: var(--color-neutral-text-secondary);">Highest Severity</span>
                                    <span class="anomaly-summary-severity anomaly-unknown" style="font-size: var(--font-size-body); font-weight: var(--font-weight-medium);">Loading...</span>
                                </div>
                            </div>
                            <div class="structured-list-item">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: var(--font-size-body); color: var(--color-neutral-text-secondary);">Active Anomalies</span>
                                    <span class="anomaly-summary-count" style="font-size: var(--font-size-body-large); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary);">â€”</span>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div style="font-size: var(--font-size-label); color: var(--color-neutral-text-secondary); text-transform: uppercase; letter-spacing: 0.16px; margin-bottom: var(--spacing-md); font-weight: var(--font-weight-medium);">Per-Metric Status</div>
                            <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-sm);">
                                <span class="tag metric-chip metric-cpu metric-ok">CPU: OK</span>
                                <span class="tag metric-chip metric-memory metric-ok">Memory: OK</span>
                                <span class="tag metric-chip metric-disk metric-ok">Disk: OK</span>
                                <span class="tag metric-chip metric-network metric-ok">Network: OK</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Metrics Overview - IBM Carbon Title Tiles -->
            {% if latest_metric %}
            <section style="margin-bottom: var(--spacing-3xl);">
                <h2 style="font-size: var(--font-size-heading-lg); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary); margin: 0 0 var(--spacing-xl) 0; line-height: var(--line-height-heading-lg);">System Metrics</h2>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-lg);">
                    <!-- CPU Metrics -->
                    <div class="title-tile">
                        <div style="margin-bottom: var(--spacing-lg);">
                            <h3 style="font-size: var(--font-size-heading-md); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary); margin: 0 0 var(--spacing-sm) 0; line-height: var(--line-height-heading-md);">CPU</h3>
                            <div style="font-size: var(--font-size-display); font-weight: var(--font-weight-bold); color: var(--color-neutral-text-primary); line-height: var(--line-height-display);">
                                {{ latest_metric.cpu_percent|floatformat:1 }}%
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: var(--font-size-body); color: var(--color-neutral-text-secondary);">Load Average (1m)</span>
                                <span style="font-size: var(--font-size-body); font-weight: var(--font-weight-medium); color: var(--color-neutral-text-primary);">
                                    {% if latest_metric.cpu_load_avg_1m %}
                                        {{ latest_metric.cpu_load_avg_1m|floatformat:2 }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Memory Metrics -->
                    <div class="title-tile">
                        <div style="margin-bottom: var(--spacing-lg);">
                            <h3 style="font-size: var(--font-size-heading-md); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary); margin: 0 0 var(--spacing-sm) 0; line-height: var(--line-height-heading-md);">Memory</h3>
                            <div style="font-size: var(--font-size-display); font-weight: var(--font-weight-bold); color: var(--color-neutral-text-primary); line-height: var(--line-height-display);">
                                {{ latest_metric.memory_percent|floatformat:1 }}%
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: var(--font-size-body); color: var(--color-neutral-text-secondary);">Used / Total</span>
                                <span style="font-size: var(--font-size-body); font-weight: var(--font-weight-medium); color: var(--color-neutral-text-primary);">
                                    {% if latest_metric.memory_used and latest_metric.memory_total %}
                                        {{ latest_metric.memory_used|filesizeformat }} / {{ latest_metric.memory_total|filesizeformat }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Disk Metrics -->
                    <div class="title-tile">
                        <div style="margin-bottom: var(--spacing-lg);">
                            <h3 style="font-size: var(--font-size-heading-md); font-weight: var(--font-weight-semibold); color: var(--color-neutral-text-primary); margin: 0 0 var(--spacing-sm) 0; line-height: var(--line-height-heading-md);">Disk</h3>
                            <div style="font-size: var(--font-size-display); font-weight: var(--font-weight-bold); color: var(--color-neutral-text-primary); line-height: var(--line-height-display);">
                                {{ disk_percent|default:"0"|floatformat:1 }}%
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: var(--font-size-body); color: var(--color-neutral-text-secondary);">Total Space</span>
                                <span style="font-size: var(--font-size-body); font-weight: var(--font-weight-medium); color: var(--color-neutral-text-primary);">
                                    {% if disk_info and disk_info.total %}
                                        {{ disk_info.total|filesizeformat }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            {% endif %}

        </div>
    </div>
</div>
{% endblock %}
