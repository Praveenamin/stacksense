{% extends "core/base.html" %}
{% load static %}

{% block title %}Dashboard - StackSense{% endblock %}

{% block extrahead %}
<link rel="stylesheet" href="{% static 'core/css/components/dashboard.css' %}">
<style>
    .slo-view-toggle.active {
        background-color: white !important;
        color: var(--cds-color-gray-100, #0f172a) !important;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    .slo-view-toggle:not(.active) {
        background-color: transparent !important;
        color: var(--cds-color-gray-70, #334155) !important;
    }
    .slo-view-toggle:hover {
        background-color: rgba(255, 255, 255, 0.5) !important;
    }
</style>
<style>
    .news-ticker-container {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border-radius: 8px;
        padding: 12px 20px;
        margin-bottom: 32px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }
    .news-ticker-header {
        font-size: 12px;
        font-weight: 600;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 8px;
    }
    .news-ticker-wrapper {
        overflow: hidden;
        position: relative;
    }
    .news-ticker-content {
        display: inline-flex;
        white-space: nowrap;
        animation: scroll-news 60s linear infinite;
    }
    @keyframes scroll-news {
        0% { transform: translateX(0); }
        100% { transform: translateX(-50%); }
    }
    .news-item {
        display: inline-block;
        padding: 4px 12px;
        margin: 0 8px;
        border-radius: 4px;
        font-size: 14px;
    }
    .news-item-high { background-color: rgba(239, 68, 68, 0.2); color: #fca5a5; }
    .news-item-warning { background-color: rgba(245, 158, 11, 0.2); color: #fcd34d; }
    .news-item-info { background-color: rgba(59, 130, 246, 0.2); color: #93c5fd; }
    .news-item-separator { color: #64748b; margin: 0 4px; }
</style>
{% endblock %}

{% block content %}
    <div class="news-ticker-container">
        <div class="news-ticker-header">System Status News Feed</div>
        <div class="news-ticker-wrapper">
            <div class="news-ticker-content" id="news-ticker-content">
                <span class="news-ticker-loading">Loading system status updates...</span>
            </div>
        </div>
    </div>

    {% include "core/components/dashboard/alerts_banner.html" %}
    {% include "core/components/dashboard/summary_metrics_card.html" %}
    
    <!-- SLI/SLO Compliance Section -->
    <div class="dashboard-component" style="margin-bottom: 32px;">
        <div class="dashboard-component-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="dashboard-component-title">SLO Compliance</h3>
            <div style="display: flex; gap: 8px; align-items: center;">
                <div style="display: flex; gap: 4px; background-color: var(--cds-color-gray-10, #f8fafc); border-radius: 4px; padding: 2px;">
                    <button id="slo-view-overall" class="slo-view-toggle active" style="padding: 6px 12px; border: none; background: transparent; color: var(--cds-color-gray-100, #0f172a); font-size: 14px; font-weight: 500; cursor: pointer; border-radius: 4px;">Overall</button>
                    <button id="slo-view-server" class="slo-view-toggle" style="padding: 6px 12px; border: none; background: transparent; color: var(--cds-color-gray-70, #334155); font-size: 14px; font-weight: 500; cursor: pointer; border-radius: 4px;">Server</button>
                </div>
                <select id="slo-server-select" style="display: none; padding: 6px 12px; border: 1px solid var(--cds-color-gray-20, #e2e8f0); border-radius: 4px; font-size: 14px; background: white; color: var(--cds-color-gray-100, #0f172a); cursor: pointer;">
                    <option value="">Select Server...</option>
                </select>
            </div>
        </div>
        <div class="dashboard-component-content">
            <div id="slo-compliance-gauges-container">
                <!-- Gauges will be populated by JavaScript -->
            </div>
        </div>
        <div class="dashboard-loading" id="dashboard-loading-sli-compliance" style="display: none;">
            <div class="loading-spinner"></div>
            <span>Loading...</span>
        </div>
        <div class="dashboard-error" id="dashboard-error-sli-compliance" style="display: none;">
            <span id="dashboard-error-message-sli-compliance"></span>
        </div>
    </div>
    
    <div class="dashboard-grid dashboard-grid-2col" style="margin-bottom: 32px;">
        {% include "core/components/dashboard/cpu_trend_chart.html" %}
        {% include "core/components/dashboard/memory_trend_chart.html" %}
    </div>
    
    <div class="dashboard-grid dashboard-grid-2col" style="margin-bottom: 32px;">
        {% include "core/components/dashboard/network_traffic_chart.html" %}
        {% include "core/components/dashboard/disk_io_summary.html" %}
    </div>
    
    <div class="dashboard-grid dashboard-grid-2col" style="margin-bottom: 32px;">
        {% include "core/components/dashboard/top_cpu_consumers.html" %}
        {% include "core/components/dashboard/top_memory_consumers.html" %}
    </div>
    
    <div class="dashboard-grid dashboard-grid-2col" style="margin-bottom: 32px;">
        {% include "core/components/dashboard/health_status_chart.html" %}
        {% include "core/components/dashboard/alert_timeline.html" %}
    </div>
    
    <div class="dashboard-grid dashboard-grid-2col" style="margin-bottom: 32px;">
        {% include "core/components/dashboard/ai_recommendations.html" %}
        {% include "core/components/dashboard/disk_forecast.html" %}
    </div>
    
    <div class="dashboard-grid dashboard-grid-2col" style="margin-bottom: 32px;">
        {% include "core/components/dashboard/agent_version_summary.html" %}
        {% include "core/components/dashboard/login_activity_summary.html" %}
    </div>

{% endblock %}

{% block extrajs %}
<script src="{% static 'core/js/anomaly_status.js' %}"></script>
<script src="{% static 'core/js/components/dashboard/BaseDashboardComponent.js' %}"></script>
<script src="{% static 'core/js/components/dashboard/ChartWrapper.js' %}"></script>
<script src="{% static 'core/js/components/dashboard/SummaryMetricsCard.js' %}"></script>
<script src="{% static 'core/js/components/dashboard/AlertsBanner.js' %}"></script>
<script src="{% static 'core/js/components/dashboard/CPUTrendChart.js' %}"></script>
<script src="{% static 'core/js/components/dashboard/MemoryTrendChart.js' %}"></script>
<script src="{% static 'core/js/components/dashboard/NetworkTrafficChart.js' %}"></script>
<script src="{% static 'core/js/components/dashboard/DiskIOSummary.js' %}"></script>
<script src="{% static 'core/js/components/dashboard/TopCPUConsumers.js' %}"></script>
<script src="{% static 'core/js/components/dashboard/TopMemoryConsumers.js' %}"></script>
<script src="{% static 'core/js/components/dashboard/HealthStatusChart.js' %}"></script>
<script src="{% static 'core/js/components/dashboard/AlertTimeline.js' %}"></script>
<script src="{% static 'core/js/components/dashboard/AIRecommendations.js' %}"></script>
<script src="{% static 'core/js/components/dashboard/DiskForecast.js' %}"></script>
<script src="{% static 'core/js/components/dashboard/AgentVersionSummary.js' %}"></script>
<script src="{% static 'core/js/components/dashboard/LoginActivitySummary.js' %}"></script>
<script src="{% static 'core/js/components/dashboard/SLOComplianceGauges.js' %}"></script>
<script src="{% static 'core/js/components/DashboardManager.js' %}"></script>
<script>
    function loadNewsFeed() {
        fetch('/api/dashboard/news-feed/')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.news_items && data.news_items.length > 0) {
                    const newsContent = document.getElementById('news-ticker-content');
                    let html = '';
                    const items = [...data.news_items, ...data.news_items];
                    items.forEach((item, index) => {
                        let severityClass = '';
                        if (item.severity === 'high' || item.severity === 'critical') {
                            severityClass = 'news-item-high';
                        } else if (item.severity === 'warning' || item.severity === 'medium') {
                            severityClass = 'news-item-warning';
                        } else {
                            severityClass = 'news-item-info';
                        }
                        html += `<span class="news-item ${severityClass}">${item.icon} ${item.text}</span>`;
                        if (index < items.length - 1) {
                            html += '<span class="news-item-separator">‚Ä¢</span>';
                        }
                    });
                    newsContent.innerHTML = html;
                } else {
                    document.getElementById('news-ticker-content').innerHTML = 
                        '<span class="news-item-info">üìä All systems operational - No recent events to report</span>';
                }
            })
            .catch(error => {
                console.error('Error loading news feed:', error);
                document.getElementById('news-ticker-content').innerHTML = 
                    '<span class="news-item-warning">‚ö†Ô∏è Unable to load system status updates</span>';
            });
    }
    loadNewsFeed();
    setInterval(loadNewsFeed, 30000);
    let dashboardManager;
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof DashboardManager !== 'undefined') {
            dashboardManager = new DashboardManager();
            dashboardManager.init();
        }
    });
    window.addEventListener('beforeunload', function() {
        if (dashboardManager) {
            dashboardManager.destroy();
        }
    });
</script>
{% endblock %}
